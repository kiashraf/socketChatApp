<html>
<head>
    <title>Chat </title>

    <link href="/css/custom.css" rel="stylesheet">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
</head>
<style>
    body{
        margin-top: 100px;
    }

</style>
<body>

<div class="container">
    <div class="row">

        <div class="col-md-4">
            <div class="well">
                <h3 class=" glyphicon glyphicon-comment"> Online Users </h3>
                <ul class="list-group" id="users">



                </ul>



                <h3> Hello! <span><strong> <%= currentUser.name %>  </strong></span>, You can chat with following people </h3>

                <div class="roomsListDiv container-fluid">
                    <ul class="roomsList list-group" id="roomsListUL">
                        <!-- Loop list items here -->

                    </ul>
                </div>



            </div>


        </div>

        <div class="col-md-8">

            <div class="panel panel-primary" id="chat">
                <div class="panel-heading">You are chatting with <%= toUserName%> </div>
                <ul class="list-group" id="chatNew">

                </ul>
            </div>
            <form id="messageForm">
                <!--<div class="form-group">
                    <label>Enter Message</label>
                  <textarea class="form-control  chat-input" id="message">

                   </textarea>
                    <br/>
                    <input type="submit" class="btn btn-primary" value="send message"/>
                </div>-->

                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Type message" id="message">
      <span class="input-group-btn">
        <button class="btn btn-info " type="submit"> send message</button>
      </span>
                </div>

            </form>

        </div>

    </div>


</div>
<script>
    $(function () {

        var socket = io('http://127.0.0.1:3000/chat');
        var $messageForm = $('#messageForm');
        var $message = $('#message');
        var $chat = $('#chat');
        var $chatNew = $('#chatNew');


         var to = '<%- to %>';
        var from = '<%- currentUser.name %>';
        var currentUserId= '<%-currentUser._id%>';
        var currentUserName = '<%- currentUser.name %>';

        let renderOnlineUsers = function (OnLineUsers) {
            let roomsListDiv = $('#roomsListUL');
            let listStr = '';
            for (var i=0;i< OnLineUsers.length;i++) {
                if(OnLineUsers[i].userId !==currentUserId ) {
                    listStr += `<a href="/socket/${OnLineUsers[i].userId}"><li class="list-group-item">${OnLineUsers[i].userName}</li></a>`;
                } }
            roomsListDiv.html('').append(listStr);
        }
        socket.on('onlineUsersList', function (OnLineUsers) {
            renderOnlineUsers(OnLineUsers);
        });

        $messageForm.submit(function (e) {
            e.preventDefault();
            socket.emit('client message', { msg: $message.val(), to : to , from : from});
            $message.val('');


        });

        socket.on('server message', function (data) {
            $chatNew.append('<li class="list-group-item"> <strong> '+data.from +'</strong>'+' : '+data.msg+ '</li>');
        })
        socket.emit('join', {currentUserId : currentUserId , currentUserName : currentUserName});

      //  socket.emit('getOnlineUsers');




    })


</script>

</body>
</html>